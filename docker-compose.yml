services:
  domain-controller:
    build:
      context: ./domain-controller
    container_name: domain-controller

    # Suba o DC direto; os outros serviÃ§os sobem em paralelo.
    command: >
      /opt/jboss/wildfly/bin/domain.sh
      --host-config=host-master.xml
      -b 0.0.0.0
      -bmanagement 0.0.0.0

    ports:
      - "9990:9990"
      - "9999:9999"

    environment:
      - NODE_NAME=domain-controller

    volumes:
      - ./domain-controller/config/host-master.xml:/opt/jboss/wildfly/domain/configuration/host-master.xml:ro
      - ./domain-controller/domain/configuration/mgmt-users.properties:/opt/jboss/wildfly/domain/configuration/mgmt-users.properties
      - ./domain-controller/domain/configuration/mgmt-groups.properties:/opt/jboss/wildfly/domain/configuration/mgmt-groups.properties

    networks:
      - wildfly-net

  host1:
    build:
      context: ./domain-controller
    container_name: host1

    command: >
      /opt/wait-for-it.sh domain-controller:9999 -t 120 --
      /opt/jboss/wildfly/bin/domain.sh
      --host-config=host1.xml
      -Djboss.domain.master.address=domain-controller
      -b 0.0.0.0
      -bmanagement 0.0.0.0

    volumes:
      - ./host1/config/host1.xml:/opt/jboss/wildfly/domain/configuration/host1.xml
      - ./domain-controller/domain/configuration/mgmt-users.properties:/opt/jboss/wildfly/domain/configuration/mgmt-users.properties
      - ./domain-controller/domain/configuration/mgmt-groups.properties:/opt/jboss/wildfly/domain/configuration/mgmt-groups.properties

    environment:
      - NODE_NAME=host1

    depends_on:
      - domain-controller

    networks:
      - wildfly-net

  host2:
    build:
      context: ./domain-controller
    container_name: host2

    command: >
      /opt/wait-for-it.sh domain-controller:9999 -t 120 --
      /opt/jboss/wildfly/bin/domain.sh
      --host-config=host2.xml
      -Djboss.domain.master.address=domain-controller
      -b 0.0.0.0
      -bmanagement 0.0.0.0

    volumes:
      - ./host2/config/host2.xml:/opt/jboss/wildfly/domain/configuration/host2.xml

    environment:
      - NODE_NAME=host2

    depends_on:
      - domain-controller

    networks:
      - wildfly-net

  nginx:
    image: nginx:alpine
    container_name: nginx-lb
    ports:
      - "80:80"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    depends_on:
      - host1
      - host2
    networks:
      - wildfly-net

  opensearch:
    image: opensearchproject/opensearch:2.11.1
    container_name: opensearch
    environment:
      - plugins.security.disabled=true
      - discovery.type=single-node
      - "OPENSEARCH_JAVA_OPTS=-Xms512m -Xmx512m"
    ulimits:
      memlock:
        soft: -1
        hard: -1
    ports:
      - "9200:9200"
      - "9600:9600"
    volumes:
      - opensearch-data:/usr/share/opensearch/data
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:9200"]
      interval: 10s
      timeout: 5s
      retries: 10
    networks:
      - wildfly-net

  mongodb:
    image: mongo:noble
    container_name: mongodb
    volumes:
      - mongodb-data:/data/db
    ports:
      - "27017:27017"
    networks:
      - wildfly-net

  graylog:
    image: graylog/graylog:6.2.12-1
    container_name: graylog
    environment:
      - GRAYLOG_PASSWORD_SECRET=soa23e0597b418c6fd
      - GRAYLOG_ROOT_PASSWORD_SHA2=e86f78a8a3caf0b60d8e74e5942aa6d86dc150cd3c03338aef25b7d2d7e3acc7
      - GRAYLOG_HTTP_EXTERNAL_URI=http://graylog:9000/
      - GRAYLOG_ELASTICSEARCH_HOSTS=http://opensearch:9200
      - GRAYLOG_MONGODB_URI=mongodb://mongodb:27017/graylog
      - TZ=America/Sao_Paulo
    ports:
      - "9000:9000"
      - "12201:12201/udp"
    depends_on:
      - opensearch
      - mongodb
    networks:
      - wildfly-net

networks:
  wildfly-net:
    driver: bridge

volumes:
  mongodb-data:
  opensearch-data: